
> **æ›´æ–°è¯´æ˜**ï¼šæœ¬ç« èŠ‚åˆ—å‡ºäº†åœ¨æ–°ç‰ˆæœ¬ Solidityã€EVM å‡çº§æˆ–ç”Ÿæ€ç³»ç»Ÿå˜åŒ–åä¸å†æœ‰æ•ˆæˆ–é‡è¦æ€§å¤§å¹…é™ä½çš„ä¼˜åŒ–æŠ€å·§ã€‚

## 1. external æ¯” public æ›´ä¾¿å®œ

**è¿‡æ—¶åŸå› ï¼š** ç¼–è¯‘å™¨ä¼˜åŒ–æ”¹è¿›

å¦‚æœå‡½æ•°æ— æ³•åœ¨åˆçº¦å†…éƒ¨è°ƒç”¨ï¼Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œä»ç„¶åº”è¯¥ä¼˜å…ˆé€‰æ‹© external ä¿®é¥°ç¬¦ï¼Œä½†å®ƒå¯¹äºèŠ‚çœ gas æ²¡æœ‰å½±å“ã€‚

**æ—¶é—´çº¿ï¼š** çº¦ Solidity 0.8.x ä¹‹åæ•ˆæœä¸æ˜æ˜¾

---

## 2. != 0 æ¯” > 0 æ›´ä¾¿å®œ

**è¿‡æ—¶åŸå› ï¼š** ç¼–è¯‘å™¨ä¼˜åŒ–æ”¹è¿›

å¤§çº¦åœ¨ Solidity 0.8.12 å·¦å³ï¼Œè¿™ä¸ªè¯´æ³•ä¸å†æˆç«‹ã€‚å¦‚æœä½ è¢«è¿«ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œä½ ä»ç„¶å¯ä»¥å¯¹å…¶è¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚

**æ—¶é—´çº¿ï¼š** Solidity 0.8.12+

---

## 3. è·¨äº¤æ˜“ä½¿ç”¨ SELFDESTRUCT åˆ é™¤åˆçº¦å’Œæ¸…ç†å­˜å‚¨

> **âš ï¸ é‡è¦ï¼š** è¿™æ˜¯ Cancun å‡çº§å½±å“æœ€å¤§çš„å˜æ›´ä¹‹ä¸€ï¼

**è¿‡æ—¶åŸå› ï¼š** EIP-6780 é™åˆ¶äº† SELFDESTRUCT çš„è¡Œä¸º

### ä¸ºä»€ä¹ˆè¿‡æ—¶

åœ¨ Cancun å‡çº§ï¼ˆ2024å¹´3æœˆï¼‰ä¹‹åï¼Œ`SELFDESTRUCT` ä»…åœ¨ä»¥ä¸‹æƒ…å†µä¿ç•™å®Œæ•´åŠŸèƒ½ï¼š
- **åŒä¸€äº¤æ˜“å†…åˆ›å»ºå¹¶é”€æ¯çš„åˆçº¦**

å¯¹äºå·²å­˜åœ¨çš„åˆçº¦è°ƒç”¨ `SELFDESTRUCT`ï¼š
- âŒ **ä¸å†**åˆ é™¤åˆçº¦ä»£ç 
- âŒ **ä¸å†**æ¸…é™¤å­˜å‚¨
- âœ… ä»…è½¬ç§» ETH ä½™é¢
- âŒ **ä¸å†**é€€è¿˜ gas

### å—å½±å“çš„æ¨¡å¼

```solidity
// âŒ ä¸å†æœ‰æ•ˆï¼šè·¨äº¤æ˜“é”€æ¯
contract OldPattern {
    function cleanup() external {
        selfdestruct(payable(msg.sender));
        // ä»£ç å’Œå­˜å‚¨ä¸ä¼šè¢«åˆ é™¤ï¼
    }
}

// âŒ ä¸å†æœ‰æ•ˆï¼šCREATE2 + SELFDESTRUCT é‡æ–°éƒ¨ç½²
contract RedeployPattern {
    function redeploy(bytes32 salt) external {
        address deployed = address(new Contract{salt: salt}());
        Contract(deployed).destroy();
        // æ— æ³•åœ¨åŒä¸€åœ°å€é‡æ–°éƒ¨ç½²
    }
}
```

### æ›¿ä»£æ–¹æ¡ˆ

- ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼ˆUUPS / é€æ˜ä»£ç†ï¼‰
- ä½¿ç”¨æœ€å°å…‹éš†ï¼ˆEIP-1167ï¼‰
- ä½¿ç”¨çŠ¶æ€æ ‡å¿—åœç”¨åˆçº¦

**å‚è€ƒï¼š**
- [Chapter 2 ç¬¬4èŠ‚](https://learnblockchain.cn/article/22693?course_id=95#4.%20selfdestruct%20%E4%B8%80%E6%AC%A1%E6%80%A7%E5%90%88%E7%BA%A6)

**æ—¶é—´çº¿ï¼š** Cancun å‡çº§ï¼ˆ2024å¹´3æœˆï¼‰å

---

## 4. L2 ä¸Šæè‡´ä¼˜åŒ– Calldata ä¸­çš„é›¶å­—èŠ‚

> **âš ï¸ é‡è¦ï¼š** EIP-4844 å¯¹ L2 çš„ calldata ä¼˜åŒ–ç­–ç•¥äº§ç”Ÿé©å‘½æ€§å½±å“ï¼

**è¿‡æ—¶åŸå› ï¼š** EIP-4844 å¼•å…¥çš„ Blob äº¤æ˜“æ”¹å˜äº† L2 çš„æ•°æ®å‘å¸ƒæœºåˆ¶

### ä¸ºä»€ä¹ˆé‡è¦æ€§é™ä½

åœ¨ EIP-4844 ä¹‹å‰ï¼ŒL2 éœ€è¦å°†æ‰€æœ‰äº¤æ˜“æ•°æ®ä½œä¸º calldata å‘å¸ƒåˆ° L1ï¼š
- é›¶å­—èŠ‚ï¼š4 gas
- éé›¶å­—èŠ‚ï¼š16 gas
- å·®è·ï¼š**4å€**

åœ¨ EIP-4844 ä¹‹åï¼ŒL2 ä¸»è¦ä½¿ç”¨ Blob äº¤æ˜“å‘å¸ƒæ•°æ®ï¼š
- Blob æ•°æ®ï¼š**ä¸åŒºåˆ†**é›¶å­—èŠ‚å’Œéé›¶å­—èŠ‚
- æ€»æˆæœ¬é™ä½ï¼š**80-90%**

### å—å½±å“çš„ä¼˜åŒ–

```solidity
// âš ï¸ åœ¨ L2 ä¸Šé‡è¦æ€§å¤§å¹…é™ä½
contract CalldataOptimization {
    // ä½¿ç”¨è™šè£åœ°å€ï¼ˆå‰å¯¼é›¶ï¼‰
    address public constant TOKEN = 0x0000000000000000000000000000000000000001;

    // å‹ç¼©åœ°å€åˆ° uint160
    function compress(address addr) external pure returns (uint160) {
        return uint160(addr);
    }

    // ä½¿ç”¨çŸ­å‡½æ•°å
    function t() external {} // è€Œä¸æ˜¯ transfer()
}
```

### æ–°çš„ä¼˜åŒ–ä¼˜å…ˆçº§ï¼ˆL2ï¼‰

**é«˜ä¼˜å…ˆçº§ï¼š**
- âœ… å­˜å‚¨ä¼˜åŒ–ï¼ˆå˜é‡æ‰“åŒ…ã€ä¸´æ—¶å­˜å‚¨ï¼‰
- âœ… è®¡ç®—ä¼˜åŒ–ï¼ˆå¾ªç¯ã€uncheckedï¼‰
- âœ… åˆçº¦æ¶æ„ä¼˜åŒ–

**ä½ä¼˜å…ˆçº§ï¼š**
- ğŸ”» Calldata é›¶å­—èŠ‚ä¼˜åŒ–
- ğŸ”» è™šè£åœ°å€
- ğŸ”» å‡½æ•°åå‹ç¼©

### ä»éœ€ä¼˜åŒ–çš„åœºæ™¯

- L1 ä¸»ç½‘åˆçº¦ï¼ˆå®Œå…¨é€‚ç”¨ï¼‰
- L1â†”L2 è·¨é“¾æ¶ˆæ¯ï¼ˆä»ä½¿ç”¨ calldataï¼‰
- æå¤§æ•°æ®é‡çš„æ“ä½œ

**å‚è€ƒï¼š** [Chapter 5](https://learnblockchain.cn/article/22696) å®Œæ•´åˆ†æ

**æ—¶é—´çº¿ï¼š** Cancun å‡çº§ï¼ˆ2024å¹´3æœˆï¼‰å

---

## 5. æŸäº›ç¼–è¯‘å™¨ç‰¹å®šçš„ä¼˜åŒ–æŠ€å·§

**è¿‡æ—¶åŸå› ï¼š** ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–æ”¹è¿›

### éƒ¨åˆ†è¢«ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–çš„æŠ€å·§

éšç€ Solidity ç¼–è¯‘å™¨çš„ä¸æ–­æ”¹è¿›ï¼ˆ0.8.20 â†’ 0.8.28ï¼‰ï¼ŒæŸäº›æ‰‹åŠ¨ä¼˜åŒ–å·²è¢«ç¼–è¯‘å™¨è‡ªåŠ¨åº”ç”¨ï¼š

#### 5.1 PUSH0 ä¼˜åŒ–ï¼ˆ0.8.20+ï¼‰

```solidity
// ç¼–è¯‘å™¨ç°åœ¨è‡ªåŠ¨ä½¿ç”¨ PUSH0
function getZero() public pure returns (uint256) {
    return 0;  // è‡ªåŠ¨ä½¿ç”¨ PUSH0 æ“ä½œç 
}
```

**å½±å“ï¼š** æ— éœ€æ‰‹åŠ¨ä¼˜åŒ–é›¶å€¼åˆå§‹åŒ–

#### 5.2 éƒ¨åˆ†å¾ªç¯ä¼˜åŒ–ï¼ˆ0.8.22+ï¼‰

```solidity
// ç¼–è¯‘å™¨å¯èƒ½è‡ªåŠ¨è¯†åˆ«å®‰å…¨çš„å¾ªç¯
for (uint256 i = 0; i < arr.length; i++) {
    // æŸäº›æƒ…å†µä¸‹ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–
}
```

**å½±å“ï¼š** ä½†ä»å»ºè®®æ˜¾å¼ä½¿ç”¨ `unchecked { ++i }`

#### 5.3 ç®€å•ä½ç§»ä¼˜åŒ–

```solidity
// ç¼–è¯‘å™¨å¯èƒ½è‡ªåŠ¨ä¼˜åŒ–ä¸ºä½ç§»
uint256 x = y * 2;   // å¯èƒ½ä¼˜åŒ–ä¸º y << 1
uint256 z = y / 4;   // å¯èƒ½ä¼˜åŒ–ä¸º y >> 2
```

**å½±å“ï¼š** å¯¹äº 2 çš„å¹‚æ¬¡ä¹˜é™¤æ³•ï¼Œç¼–è¯‘å™¨å¯èƒ½è‡ªåŠ¨ä¼˜åŒ–

### å»ºè®®

- âœ… ä»ç„¶æµ‹è¯•ä¼˜åŒ–æ•ˆæœ
- âœ… å…³æ³¨ç¼–è¯‘å™¨ç‰ˆæœ¬å·®å¼‚
- âœ… ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼ˆ0.8.24+ï¼‰
- âš ï¸ ä¸è¦ç›²ç›®ä¿¡ä»»ç¼–è¯‘å™¨ï¼Œå§‹ç»ˆåŸºå‡†æµ‹è¯•

**æ—¶é—´çº¿ï¼š** [Solidity](https://learnblockchain.cn/course/93) 0.8.20+ é€æ­¥æ”¹è¿›

---

## 6. è¿‡åº¦ä¾èµ– SSTORE2 ç”¨äºä¸´æ—¶æ•°æ®

**è¿‡æ—¶åŸå› ï¼š** ä¸´æ—¶å­˜å‚¨ï¼ˆTransient Storageï¼‰æä¾›äº†æ›´å¥½çš„æ–¹æ¡ˆ

### ä¸ºä»€ä¹ˆé‡è¦æ€§é™ä½

**SSTORE2ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰ï¼š**
- å°†æ•°æ®ä½œä¸ºå­—èŠ‚ç å­˜å‚¨
- æˆæœ¬ï¼š~200 gas/å­—èŠ‚ï¼ˆå†™å…¥ï¼‰
- æŒä¹…æ€§ï¼šæ°¸ä¹…å­˜å‚¨
- é€‚ç”¨ï¼šéœ€è¦é•¿æœŸä¿å­˜çš„å¤§é‡æ•°æ®

**ä¸´æ—¶å­˜å‚¨ï¼ˆEIP-1153ï¼‰ï¼š**
- ä»…åœ¨äº¤æ˜“æœŸé—´å­˜åœ¨
- æˆæœ¬ï¼š100 gasï¼ˆTSTORE/TLOADï¼‰
- æŒä¹…æ€§ï¼šäº¤æ˜“ç»“æŸåæ¸…é›¶
- é€‚ç”¨ï¼šå•äº¤æ˜“å†…çš„ä¸´æ—¶çŠ¶æ€

### å¯¹æ¯”ç¤ºä¾‹

```solidity
// âŒ ä½¿ç”¨ SSTORE2 å­˜å‚¨ä¸´æ—¶æ•°æ®ï¼ˆä¸å†æ¨èï¼‰
contract OldApproach {
    mapping(uint256 => address) tempDataPointers;

    function processBatch(bytes[] calldata items) external {
        // å°†ä¸´æ—¶æ•°æ®å­˜å‚¨åˆ° SSTORE2
        address pointer = SSTORE2.write(abi.encode(items));
        tempDataPointers[block.number] = pointer;

        // å¤„ç†...

        // éœ€è¦æ‰‹åŠ¨æ¸…ç†
    }
}

// âœ… ä½¿ç”¨ä¸´æ—¶å­˜å‚¨ï¼ˆæ¨èï¼‰
contract NewApproach {
    mapping(uint256 => bytes) private transient tempData;

    function processBatch(bytes[] calldata items) external {
        for (uint256 i = 0; i < items.length; i++) {
            tempData[i] = items[i];  // TSTORE: 100 gas
        }

        // å¤„ç†...

        // äº¤æ˜“ç»“æŸåè‡ªåŠ¨æ¸…é›¶ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
    }
}
```

### ä½•æ—¶ä»ä½¿ç”¨ SSTORE2

- âœ… éœ€è¦æ°¸ä¹…ä¿å­˜çš„å¤§é‡æ•°æ®ï¼ˆ> 24 KBï¼‰
- âœ… éœ€è¦è·¨äº¤æ˜“è®¿é—®çš„æ•°æ®
- âœ… é“¾ä¸Š [NFT](https://learnblockchain.cn/tags/NFT) å…ƒæ•°æ®å­˜å‚¨

### ä½•æ—¶ä½¿ç”¨ä¸´æ—¶å­˜å‚¨

- âœ… å•äº¤æ˜“å†…çš„ä¸´æ—¶çŠ¶æ€
- âœ… é‡å…¥é”
- âœ… é—ªç”µè´·çŠ¶æ€ç®¡ç†
- âœ… æ‰¹é‡æ“ä½œçš„ä¸­é—´æ•°æ®

**å‚è€ƒï¼š**
- [Gas ä¼˜åŒ–å¸¸ç”¨æŠ€å·§](https://learnblockchain.cn/article/22692?course_id=95#7.%20%E4%BD%BF%E7%94%A8%E7%9E%AC%E6%97%B6%E5%AD%98%E5%82%A8)


**æ—¶é—´çº¿ï¼š** Cancun å‡çº§ï¼ˆ2024å¹´3æœˆï¼‰å

---

## æ€»ç»“

### è¿‡æ—¶æŠ€å·§åˆ†ç±»

**ç¼–è¯‘å™¨æ”¹è¿›å¯¼è‡´ï¼š**
1. external vs public
2. != 0 vs > 0
3. æŸäº›å¾ªç¯å’Œä½ç§»ä¼˜åŒ–

**[EVM](https://learnblockchain.cn/tags/EVM?map=EVM) å‡çº§å¯¼è‡´ï¼š**
4. è·¨äº¤æ˜“ SELFDESTRUCTï¼ˆCancun - EIP-6780ï¼‰
5. L2 calldata é›¶å­—èŠ‚ä¼˜åŒ–ï¼ˆCancun - EIP-4844ï¼‰
6. SSTORE2 ç”¨äºä¸´æ—¶æ•°æ®ï¼ˆCancun - EIP-1153ï¼‰

### å»ºè®®

1. **ä¿æŒæ›´æ–°**ï¼šä½¿ç”¨ [Solidity](https://learnblockchain.cn/course/93) 0.8.24+ å’Œ Cancun [EVM](https://learnblockchain.cn/tags/EVM?map=EVM)
2. **é‡æ–°è¯„ä¼°**ï¼šå®šæœŸå®¡æŸ¥ä¼˜åŒ–ç­–ç•¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
3. **åŸºå‡†æµ‹è¯•**ï¼šå§‹ç»ˆæµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **å…³æ³¨å‡çº§**ï¼šè·Ÿè¸ª[ä»¥å¤ªåŠ](https://learnblockchain.cn/tags/ä»¥å¤ªåŠ?map=EVM)å‡çº§å’Œç¼–è¯‘å™¨æ›´æ–°
5. **ä½¿ç”¨ç°ä»£å·¥å…·**ï¼šSoladyã€ä¸´æ—¶å­˜å‚¨ã€Blob äº¤æ˜“ç­‰

